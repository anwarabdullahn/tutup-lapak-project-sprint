# Database Migrations

This directory contains database migration files for the purchase service.

## Migration Files

### 1. Enable UUID Extension
- **File**: `20241220110000_enable_uuid_extension.up.sql`
- **Purpose**: Enables the UUID extension for PostgreSQL to support UUID generation
- **Rollback**: `20241220110000_enable_uuid_extension.down.sql`

### 2. Create Purchase Tables
- **File**: `20241220120000_create_purchase_tables.up.sql`
- **Purpose**: Creates the main purchase-related tables:
  - `purchases`: Main purchase orders table
  - `purchase_items`: Individual items within a purchase
  - `purchase_senders`: Sender contact information
- **Rollback**: `20241220120000_create_purchase_tables.down.sql`

### 3. Sample Data (Optional)
- **File**: `20241220130000_add_sample_purchase_data.up.sql`
- **Purpose**: Adds sample data for testing and development
- **Rollback**: `20241220130000_add_sample_purchase_data.down.sql`
- **Note**: This migration should be skipped in production

## Table Structure

### Purchases Table
```sql
CREATE TABLE purchases (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    payment_proof_ids TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Purchase Items Table
```sql
CREATE TABLE purchase_items (
    id UUID PRIMARY KEY,
    purchase_id UUID NOT NULL REFERENCES purchases(id) ON DELETE CASCADE,
    product_id VARCHAR(255) NOT NULL,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(255) NOT NULL,
    qty INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    sku VARCHAR(255),
    file_id VARCHAR(255),
    file_uri TEXT,
    file_thumbnail_uri TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Purchase Senders Table
```sql
CREATE TABLE purchase_senders (
    id UUID PRIMARY KEY,
    purchase_id UUID NOT NULL REFERENCES purchases(id) ON DELETE CASCADE,
    sender_name VARCHAR(255) NOT NULL,
    sender_contact_type VARCHAR(50) NOT NULL,
    sender_contact_detail VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Running Migrations

### Prerequisites
- PostgreSQL database
- `migrate` tool installed
- Database URL configured

### Commands
```bash
# Apply all migrations
make migrate:up

# Apply one migration step
make migrate:up-1

# Rollback all migrations
make migrate:down

# Rollback one migration step
make migrate:down-1

# Check current migration version
make migrate:version

# Create new migration
make migrate:create name=your_migration_name
```

### Manual Commands
```bash
# Apply migrations
migrate -path ./migrations/db -database "postgres://user:pass@host:5432/db?sslmode=disable" up

# Rollback migrations
migrate -path ./migrations/db -database "postgres://user:pass@host:5432/db?sslmode=disable" down
```

## Indexes

The migration creates the following indexes for better performance:
- `idx_purchases_user_id`: Index on user_id for faster user-based queries
- `idx_purchases_created_at`: Index on created_at for time-based queries
- `idx_purchase_items_purchase_id`: Index on purchase_id for joining with purchases
- `idx_purchase_items_product_id`: Index on product_id for product-based queries
- `idx_purchase_senders_purchase_id`: Index on purchase_id for joining with purchases

## Notes

- All tables use UUID v7 for primary keys (generated by the application)
- Foreign key constraints ensure data integrity
- CASCADE DELETE ensures related records are cleaned up
- Timestamps are automatically managed with timezone support
- The `payment_proof_ids` field stores JSON array of file IDs as TEXT
